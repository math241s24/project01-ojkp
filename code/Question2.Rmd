---
title: "Question 2"
author: "Kiana Fields"
date: "`r Sys.Date()`"
output: pdf_document
---


```{r importing libraries, include = FALSE}
library(tidyverse)
library(lubridate)
library(dplyr)
library(readr)
library(reshape2)
```


```{r importing data, include = FALSE}
# This code uses relative paths to find your dataset. Please run R studio through the R project in the folder.

avgAll <- read_csv("../data/air_pollutants/avgAll.csv")
avgAll2020 <- read_csv("../data/air_pollutants/avgAll2020.csv")

avgAll$year <- as.character(avgAll$year)
avgAll2020$year <- as.character(avgAll2020$year)

fires_full <- read_csv("../data/air_pollutants/fires_full.csv")
pollutants_pdx <- read_csv("../data/air_pollutants/pollutants_pdx.csv", 
    col_types = cols(Source = col_skip(), 
        `Site ID` = col_skip(), POC = col_skip(), 
        `Site Name` = col_skip(), DAILY_OBS_COUNT = col_skip(), 
        PERCENT_COMPLETE = col_skip(), AQS_PARAMETER_CODE = col_skip(), 
        CBSA_CODE = col_skip(), CBSA_NAME = col_skip(), 
        STATE_CODE = col_skip(), STATE = col_skip(), 
        COUNTY_CODE = col_skip(), COUNTY = col_skip(), 
        SITE_LATITUDE = col_skip(), SITE_LONGITUDE = col_skip()))
```


```{r}
# pollutant data stuff/wrangling
pollutants_pdx <- pollutants_pdx %>%
  rename(NO2 = "Daily Max 1-hour NO2 Concentration",
         Ozone = "Daily Max 8-hour Ozone Concentration",
         CO = "Daily Max 8-hour CO Concentration",
         SO2 = "Daily Max 1-hour SO2 Concentration",
         PM2.5 = "Daily Mean PM2.5 Concentration",
         AQI = "DAILY_AQI_VALUE",
         )

pollutants_pdx_melt <- pollutants_pdx %>%
  pivot_longer(cols = c(NO2, CO, SO2, PM2.5, Ozone, AQI),
               names_to = "variable",
               values_to = "reading") %>%
  filter(!is.na(reading))

pollutants_pdx_melt <- pollutants_pdx_melt %>% 
  filter(variable == "PM2.5" | 
           variable == "NO2" | 
           variable == "Ozone" | 
           variable == "AQI")

pollutants_pdx_melt$Date <- mdy(pollutants_pdx_melt$Date)

pollutants_pdx_melt <- pollutants_pdx_melt %>% 
  group_by(Date, variable) %>% 
  summarise(avrg_reading = mean(reading, na.rm = TRUE)) %>% 
  ungroup()

pollutants_pdx_melt <- pollutants_pdx_melt %>%
  mutate(year = year(Date))


```

```{r}
#Is there a correlation between wildfire season and air quality fluctuations in the Portland Metropolitan area?

#INTRO: 
#The intensity of Oregon's wildfire season in Oregon has increased over time as a result of historical forest management as well as climate change effects. The intensity of these fires is of concern to public safety both immediately in fire prone areas as well as for communities facing decreased air quality from smoke. We are interested in exploring this aspect of the issue of wildfires by analyzing concentration levels of major pollutants produced by wildfires (particularly PM2.5, NO2, Ozone and general AQI) before during and after fire season. 

#Approach:
#Our assumption is that during wildfire season, more pollutants are emitted into the atmosphere, meaning that from mid-May to September pollutant concentrations will go up. We used six years from our pollutant dataset which offers pollutant concentration by day as well as in a more succinct format with the first, 15th, and last day of the month. We also pulled in our fire dataset which offers the total protected acres burned by day across the six years in order to differentiate between general seasonal fluctuations and the actual severity of wildfire season across years.
#Julian's graph
#In our first graph, we focused on the concentration of carbon monoxide across years since this is one of the most prominent pollutants associated with wildfires. This data was visualized by a column graph where each column is a month, sectioned by color and year, with markers indicating the standard wildfire seasons.

# Our second graph considers other pollutant levels over each year from 2017-2023 in order to consider overall trends in pollutant concentration fluctuation. It is presented alongside wildfire data in order to consider to what extent the fluctuation is impacted by wildfire season. This is done with a series of line graphs. These plots help to better visualize the relationship between wildfires and air pollution which aligns with our primary goal.

```



```{r}
#graphing fires
#considering changing severity of fire seasons over years
ggplot(data = fires_full, aes(x=ReportDate, y = tot_ProAcres)) +
  geom_line()

fires_full <- fires_full %>%
  mutate(year = year(ReportDate))

ggplot(data = fires_full, aes(x=ReportDate, y = tot_ProAcres)) +
  geom_line() +
  facet_wrap(~year, scales = "free_x") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=5))

```


```{r}
# In the proposal we said we'd plot observations for the first, 15th, and last day of each month across one year, and observe whether there is a stark increase in pollutant concentrations during the wildfire season (July-September) and have multiple lines to see which pollutants in particular increase. 
#instead of separate lines, separate graphs for unit/interpretating reasons
#but yeah this is that from the proposal

#data for first 15th and last day of month
pollutants_FML <- pollutants_pdx_melt %>%
  mutate(day = day(Date)) %>%
  filter(day == 1 | day == 15 | day == max(day)) %>%
  select(-day)  

#2017, considering trends in just one year, can be altered for whichever year
ggplot(pollutants_FML %>% 
         filter(year == 2017), aes(x = Date, y = avrg_reading, color = variable)) +
  geom_line() +
  facet_wrap(~ variable + year, scales = "free") +
  labs(title = "Observations for First, 15th, and Last Day of Each Month",
       x = "Date", 
       y = "Reading") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size=5))


#on one super mega huge giant ggplot to see how this holds up across years
ggplot(pollutants_FML, aes(x = Date, y = avrg_reading, color = variable)) +
  geom_line() +
  facet_wrap(~ variable + year, scales = "free") +
  labs(title = "Observations for First, 15th, and Last Day of Each Month",
       x = "Date", y = "Reading") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size=5))
```





```{r}
#this could be graph 2
#uhhhh this is a visualization with all the pollutants over all the years compared to wildfires
#Its a little yucky but shows a seasonal pattern of fluctuation in pollutant levels thats pretty clear (esp for NO2 and Ozone). It also supports the wow 2020 was weird findings from other graphs
#this chunk also has this same thing but specific years (2019, 2020, and 2021) to kind of look a little more into 2020 by comparing with these other times

plots <- lapply(unique(pollutants_pdx_melt$variable), function(var) {
  ggplot(data = pollutants_pdx_melt[pollutants_pdx_melt$variable == var, ], aes(x = Date, y = avrg_reading)) +
    geom_line() +
    labs(title = paste("Reading for", var),
         x = "Date", y = "Reading")
})

fire_plot <- ggplot(data = fires_full, aes(x = ReportDate, y = tot_ProAcres)) +
  geom_line(color = "red") +
  labs(title = "Total Protected Acres Burnt",
       x = "Date", y = "Total Protected Acres")

library("gridExtra")
grid.arrange(arrangeGrob(grobs = plots, ncol = 1), fire_plot, heights = c(4, 1))


#this is that same nonsense but just for 2020:
pollutants_2020 <- pollutants_pdx_melt %>%
  filter(year(Date) == 2020)

plots <- lapply(unique(pollutants_2020$variable), function(var) {
  ggplot(data = pollutants_2020[pollutants_2020$variable == var, ], aes(x = Date, y = avrg_reading)) +
    geom_line() +
    labs(title = paste("Reading for", var, "in 2020"),
         x = "Date", y = "Reading")
})

fire_plot <- ggplot(data = fires_full[fires_full$year == 2020, ], aes(x = ReportDate, y = tot_ProAcres)) +
  geom_line(color = "red") +
  labs(title = "Total Protected Acres Burnt in 2020",
       x = "Date", y = "Total Protected Acres")

grid.arrange(arrangeGrob(grobs = plots, ncol = 1), fire_plot, heights = c(4, 1))


#aaaaannd for 2021
pollutants_2021 <- pollutants_pdx_melt %>%
  filter(year(Date) == 2021)

plots <- lapply(unique(pollutants_2021$variable), function(var) {
  ggplot(data = pollutants_2021[pollutants_2021$variable == var, ], aes(x = Date, y = avrg_reading)) +
    geom_line() +
    labs(title = paste("Reading for", var, "in 2021"),
         x = "Date", y = "Reading")
})

fire_plot <- ggplot(data = fires_full[fires_full$year == 2021, ], aes(x = ReportDate, y = tot_ProAcres)) +
  geom_line(color = "red") +
  labs(title = "Total Protected Acres Burnt in 2021",
       x = "Date", y = "Total Protected Acres")

grid.arrange(arrangeGrob(grobs = plots, ncol = 1), fire_plot, heights = c(4, 1))

#aaaand 2019
pollutants_2019 <- pollutants_pdx_melt %>%
  filter(year(Date) == 2019)

plots <- lapply(unique(pollutants_2019$variable), function(var) {
  ggplot(data = pollutants_2019[pollutants_2019$variable == var, ], aes(x = Date, y = avrg_reading)) +
    geom_line() +
    labs(title = paste("Reading for", var, "in 2019"),
         x = "Date", y = "Reading")
})

fire_plot <- ggplot(data = fires_full[fires_full$year == 2019, ], aes(x = ReportDate, y = tot_ProAcres)) +
  geom_line(color = "red") +
  labs(title = "Total Protected Acres Burnt in 2019",
       x = "Date", y = "Total Protected Acres")

grid.arrange(arrangeGrob(grobs = plots, ncol = 1), fire_plot, heights = c(4, 1))
```

```{r}
#summary statistics
#correlation across all years

pollutant_agg <- pollutants_pdx_melt %>%
  group_by(Date, variable) %>%
  summarise(avrg_reading = mean(avrg_reading, na.rm = TRUE)) %>%
  ungroup()

fires_agg <- fires_full %>%
  group_by(ReportDate) %>%
  summarise(tot_ProAcres = sum(tot_ProAcres, na.rm = TRUE)) %>%
  ungroup()

merged_data <- merge(pollutant_agg, fires_agg, by.x = "Date", by.y = "ReportDate", all = TRUE)

correlations <- lapply(unique(merged_data$variable), function(var) {
  pollutant_data <- merged_data %>%
    filter(variable == var)
  correlation <- cor.test(pollutant_data$avrg_reading, pollutant_data$tot_ProAcres)$estimate
  data.frame(Pollutant = var, Correlation = correlation)
})

correlations_df <- do.call(rbind, correlations)

print(correlations_df)



#correlation coefficients seperate for each year (some years there appears to be more of a correlation)

pollutant_agg <- pollutants_pdx_melt %>%
  group_by(Date, variable) %>%
  summarise(avrg_reading = mean(avrg_reading, na.rm = TRUE)) %>%
  ungroup()

fires_agg <- fires_full %>%
  group_by(ReportDate) %>%
  summarise(tot_ProAcres = sum(tot_ProAcres, na.rm = TRUE)) %>%
  ungroup()

merged_data <- merge(pollutant_agg, fires_agg, by.x = "Date", by.y = "ReportDate", all = TRUE)

years <- unique(year(merged_data$Date))
correlations <- lapply(years, function(yr) {
  merged_data_year <- merged_data %>%
    filter(year(Date) == yr)
  lapply(unique(merged_data_year$variable), function(var) {
    pollutant_data <- merged_data_year %>%
      filter(variable == var)
    correlation <- cor.test(pollutant_data$avrg_reading, pollutant_data$tot_ProAcres)$estimate
    data.frame(Year = yr, Pollutant = var, Correlation = correlation)
  })
})
correlations_df <- do.call(rbind, do.call(c, correlations))

print(correlations_df)


```



